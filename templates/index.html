<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD"
      crossorigin="anonymous"
    />
    <title>Fastapi Realtime Chat ðŸ’¬</title>
  </head>

  <body class="min-h-screen flex items-center justify-center px-4">
    <main class="w-full max-w-md">
      <section
        class="space-y-6 border border-neutral-700/40 rounded-2xl p-8 shadow-2xl flex flex-col"
        x-data="app()"
        x-init="init()"
      >
        <header class="text-center space-y-2">
          <div class="text-4xl">
            <i class="bi bi-chat-dots-fill"></i>
          </div>
          <h1 class="!mb-0 text-xl font-bold tracking-tight">
            Realtime Chat Server
          </h1>
          <p class="text-xs opacity-70">FastAPI WebSocket connection</p>
        </header>

        <div
          class="space-y-2 border border-neutral-700/40 rounded-xl p-4 bg-black/20"
        >
          <label class="text-xs opacity-70 flex items-center gap-2">
            <i class="bi bi-person-circle"></i>
            Select User
          </label>
          <div class="flex gap-2 items-center">
            <select x-model="email" class="flex-1">
              <template x-for="e in emails" :key="e.email">
                <option :value="e.email" x-text="e.username"></option>
              </template>
            </select>
            <button
              @click="connect"
              class="flex items-center gap-2 px-4 py-2 rounded-lg"
            >
              <i class="bi bi-plug-fill"></i>
              Connect
            </button>
          </div>
        </div>

        <template x-if="socket">
          <div class="space-y-4">
            <div
              class="flex items-center justify-center gap-2 text-xs opacity-80"
            >
              <span
                class="inline-block w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse"
              ></span>
              Connected as
              <span class="font-mono opacity-90" x-text="email"></span>
            </div>

            <div
              class="overflow-y-auto border border-neutral-700/40 rounded-xl p-4 space-y-3 text-sm bg-black/20 min-h-[220px] max-h-[320px]"
            >
              <template x-for="msg in messages" :key="msg.id">
                <div
                  class="flex"
                  :class="msg.sender.email === email ? 'justify-end' : 'justify-start'"
                >
                  <div
                    class="px-3 py-2 rounded-xl border border-neutral-600/40 max-w-[75%] break-words"
                    :class="msg.sender.email === email
                      ? 'bg-green-600/20 border-green-500/40 text-right'
                      : 'bg-neutral-800/40'"
                  >
                    <div
                      class="text-[10px] opacity-60 mb-1"
                      x-text="msg.sender.email"
                    ></div>
                    <div x-text="msg.content"></div>
                  </div>
                </div>
              </template>
            </div>

            <form @submit.prevent="sendMessage" class="flex gap-2 items-center">
              <input
                type="text"
                x-model="newMessage"
                placeholder="Type a message..."
                class="flex-1"
              />
              <button
                type="submit"
                class="flex items-center gap-2 px-4 py-2 rounded-lg"
              >
                <i class="bi bi-send-fill"></i>
                Send
              </button>
            </form>
          </div>
        </template>
      </section>

      <script id="initial-messages" type="application/json">
        {{ messages | tojson }}
      </script>

      <script>
        function app() {
          return {
            socket: null,
            messages: [],
            newMessage: "",
            email: "eslam@gmail.com",
            emails: [
              { username: "User 1", email: "eslam@gmail.com" },
              { username: "User 2", email: "kamel@gmail.com" },
            ],
            init() {
              this.messages = JSON.parse(
                document.getElementById("initial-messages").textContent,
              );
            },
            connect() {
              const protocol =
                window.location.protocol === "https" ? "wss" : "ws";
              const host = window.location.host;
              const socket = new WebSocket(
                `${protocol}://${host}/ws?email=${this.email}`,
              );
              socket.onopen = (event) => {
                console.log("onopen", event);
              };
              socket.onerror = (event) => {
                console.log("onerror", event);
              };
              socket.onclose = (event) => {
                console.log("onclose", event);
              };
              socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                this.messages.push(message);
              };
              this.socket = socket;
            },
            sendMessage() {
              if (!this.newMessage) return;
              this.socket.send(this.newMessage);
              this.newMessage = "";
            },
          };
        }
      </script>
    </main>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </body>
</html>
