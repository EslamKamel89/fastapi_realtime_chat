<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD"
      crossorigin="anonymous"
    />
    <title>Fastapi Realtime Chat ðŸ’¬</title>
  </head>

  <body class="min-h-screen flex items-center justify-center px-4">
    <main class="w-full max-w-md">
      <section
        class="space-y-6 border border-neutral-700/40 rounded-2xl p-8 shadow-2xl flex flex-col"
        x-data="app()"
        x-init="connect()"
      >
        <header class="text-center space-y-2">
          <div class="text-4xl">
            <i class="bi bi-chat-dots-fill"></i>
          </div>
          <h1 class="!mb-0 text-xl font-bold tracking-tight">
            Realtime Chat Server
          </h1>
          <p class="text-xs opacity-70">FastAPI WebSocket connection active</p>
        </header>

        <div class="flex items-center justify-center gap-2 text-xs opacity-80">
          <span
            class="inline-block w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse"
          ></span>
          Connected
        </div>

        <div
          class="flex-1 overflow-y-auto border border-neutral-700/40 rounded-xl p-4 space-y-2 text-sm text-left bg-black/20"
        >
          <template x-for="msg in messages" :key="msg + Date.now()">
            <div
              class="px-3 py-2 rounded-lg border border-neutral-600/40 w-fit max-w-full"
            >
              <span x-text="msg"></span>
            </div>
          </template>
        </div>

        <form @submit.prevent="sendMessage" class="flex gap-2 items-center">
          <input
            type="text"
            x-model="newMessage"
            placeholder="Type a message..."
            class="flex-1"
          />
          <button
            type="submit"
            class="flex items-center gap-2 px-4 py-2 rounded-lg"
          >
            <i class="bi bi-send-fill"></i>
            Send
          </button>
        </form>
      </section>

      <script>
        Date.now();
        function app() {
          return {
            socket: null,
            messages: [],
            newMessage: "",
            connect() {
              const protocol =
                window.location.protocol === "https" ? "wss" : "ws";
              const host = window.location.host;
              console.log(`${protocol}://${host}/ws`);
              const socket = new WebSocket(`${protocol}://${host}/ws`);
              socket.onopen = (event) => {
                console.log("onopen", event);
              };
              socket.onerror = (event) => {
                console.log("onerror", event);
              };
              socket.onclose = (event) => {
                console.log("onclose", event);
              };
              socket.onmessage = (event) => {
                console.log("onmessage", event);
                this.messages.push(event.data);
              };
              this.socket = socket;
            },
            sendMessage() {
              if (!this.newMessage) return;
              this.socket.send(this.newMessage);
              this.newMessage = "";
            },
          };
        }
      </script>
    </main>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </body>
</html>
